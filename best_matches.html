<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-J4RS3MC3WS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-J4RS3MC3WS');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Top Scoring FTC Matches</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 20px;
        }
        h1 {
            text-align: center;
        }
        .video-list {
            list-style: none;
            padding: 0;
        }
        .video-item {
            margin: 20px 0;
        }
        .video-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        iframe {
            width: 560px;
            height: 315px;
            max-width: 100%;
        }
        .nav-button {
            text-align: center;
            margin: 20px;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>Top Scoring FTC Matches</h1>
    <div class="nav-button">
        <a href="index.html"><button class="search-button">Back to Home</button></a>
    </div>
    <div class="search region">
        Region: <label>
            <select name="selectregion" class="selectregion">
                <option value="">All</option>
                <option value=" "></option>
                <option value="USAK">Alaska</option>
                <option value="USAL">Alabama</option>
                <option value="USAR">Arkansas</option>
                <option value="USAZ">Arizona</option>
                <option value="USCA">California</option>
                <option value="USCALA">California - Los Angeles</option>
                <option value="USCALS">California - LAUSD</option>
                <option value="USCANO">California - Northern</option>
                <option value="USCASD">California - San Diego</option>
                <option value="USCHS">Chesapeake</option>
                <option value="USCO">Colorado</option>
                <option value="USCT">Connecticut</option>
                <option value="USDE">Delaware</option>
                <option value="USFL">Florida</option>
                <option value="USGA">Georgia</option>
                <option value="USHI">Hawaii</option>
                <option value="USIA">Iowa</option>
                <option value="USID">Idaho</option>
                <option value="USIL">Illinois</option>
                <option value="USIN">Indiana</option>
                <option value="USKY">Kentucky</option>
                <option value="USLA">Louisiana</option>
                <option value="USMA">Massachusetts</option>
                <option value="USMD">Maryland</option>
                <option value="USMI">Michigan</option>
                <option value="USMN">Minnesota</option>
                <option value="USMOKS">Missouri & Kansas</option>
                <option value="USMS">Mississippi</option>
                <option value="USMT">Montana</option>
                <option value="USNC">North Carolina</option>
                <option value="USND">North Dakota</option>
                <option value="USNE">Nebraska</option>
                <option value="USNH">New Hampshire</option>
                <option value="USNJ">New Jersey</option>
                <option value="USNM">New Mexico</option>
                <option value="USNV">Nevada</option>
                <option value="USNY">New York</option>
                <option value="USNYEX">New York - Excelsior</option>
                <option value="USNYLI">New York - Long Island</option>
                <option value="USNYNY">New York - NYC</option>
                <option value="USOH">Ohio</option>
                <option value="USOK">Oklahoma</option>
                <option value="USOR">Oregon</option>
                <option value="USPA">Pennsylvania</option>
                <option value="USRI">Rhode Island</option>
                <option value="USSC">South Carolina</option>
                <option value="USTN">Tennessee</option>
                <option value="USTX">Texas</option>
                <option value="USTXCE">Texas - Central</option>
                <option value="USTXHO">Texas - Houston</option>
                <option value="USTXNO">Texas - North</option>
                <option value="USTXSO">Texas - South</option>
                <option value="USTXWP">Texas - West & Panhandle</option>
                <option value="USUT">Utah</option>
                <option value="USVA">Virginia</option>
                <option value="USVT">Vermont</option>
                <option value="USWA">Washington</option>
                <option value="USWI">Wisconsin</option>
                <option value="USWV">West Virginia</option>
                <option value="USWY">Wyoming</option>
                <option value=" "></option>
                <option value="CAAB">Alberta</option>
                <option value="CABC">British Columbia</option>
                <option value="CAON">Ontario</option>
                <option value="CAQC">Qu√©bec</option>
                <option value=" "></option>
                <option value="AU">Australia</option>
                <option value="BR">Brazil</option>
                <option value="CN">China</option>
                <option value="CY">Cyprus</option>
                <option value="DE">Germany</option>
                <option value="EG">Egypt</option>
                <option value="ES">Spain</option>
                <option value="FR">France</option>
                <option value="GB">Great Britain</option>
                <option value="IL">Israel</option>
                <option value="IN">India</option>
                <option value="JM">Jamaica</option>
                <option value="KR">South Korea</option>
                <option value="KZ">Kazakhstan</option>
                <option value="LY">Libya</option>
                <option value="MX">Mexico</option>
                <option value="NG">Nigeria</option>
                <option value="NL">Netherlands</option>
                <option value="NZ">New Zealand</option>
                <option value="QA">Qatar</option>
                <option value="RO">Romania</option>
                <option value="RU">Russia</option>
                <option value="SA">Saudi Arabia</option>
                <option value="TH">Thailand</option>
                <option value="TW">Taiwan</option>
                <option value="ZA">South Africa</option>
            </select>
        </label>
    </div>

    <div class="search auto">
        Sort by: <label>
            <select name="selectauto" class="selectauto">
                <option value="total">Total Score</option>
                <option value="auto">Auto Score</option>
            </select>
        </label>
    </div>

    <ul class="video-list" id="videoList">
        <!-- Top matches will be dynamically loaded here -->
    </ul>

    <div><a target="_blank" href="about.html">About</a></div>

    <script>
        $(document).ready(function() {
            const videoList = $('#videoList');

            function fetchAndRenderTopMatches() {
                let searchRegion = $('.selectregion').val();
                let searchAuto = $('.selectauto').val();
                let jsonUrl = 'https://ftcvideos.org/matches';

                if (searchRegion !== "") {
                    jsonUrl = 'https://ftcvideos.org/matches?region=' + searchRegion;
                }

                $.getJSON(jsonUrl, function(eventsData) {
                    let topMatches = [];

                    eventsData.forEach(event => {
                        event.matches.forEach(match => {
                            var redScoreAdjusted = match.scoreRedFinal - match.scoreBlueFoul;
                            var blueScoreAdjusted = match.scoreBlueFinal - match.scoreRedFoul;
                            if (searchAuto === 'auto') {
                                redScoreAdjusted = match.scoreRedAuto;
                                blueScoreAdjusted = match.scoreBlueAuto;
                            }
                            const totalScore = Math.max(redScoreAdjusted, blueScoreAdjusted);

                            topMatches.push({
                                eventCode: event.eventCode,
                                matchNumber: match.matchNumber,
                                description: match.description,
                                totalScore: totalScore,
                                teams: match.teams,
                                actualStartTime: match.actualStartTime
                            });
                        });
                    });

                    topMatches.sort((a, b) => b.totalScore - a.totalScore);
                    topMatches = topMatches.slice(0, 20);

                    videoList.empty();

                    if (topMatches.length === 0) {
                        videoList.append('<li class="video-item">No top matches found.</li>');
                        return;
                    }

                    $.getJSON('https://ftcvideos.org/list', function(videosData) {
                        var matchesFound = 0;
                        for (let i = 0; i < topMatches.length; i++) {
                            var match = topMatches[i];
                            const teamNumbers = match.teams.map(team => team.teamNumber.toString());

                            let bestVideo = null;
                            let bestMatch = null;

                            videosData.forEach(video => {
                                video.ftc_matches.forEach(videoMatch => {
                                    const allTeams = [...videoMatch.red_teams, ...videoMatch.blue_teams];
                                    if (teamNumbers.every(team => allTeams.includes(team))) {
                                        bestVideo = video;
                                        bestMatch = videoMatch;
                                    }
                                });
                            });

                            if (bestVideo && bestMatch) {
                                const teamNumbersText = match.teams.map(team => team.teamNumber).join(', ');
                                const videoTitle = $('<div></div>').addClass('video-title').text(`Match: ${match.description} - Teams: ${teamNumbersText} - Score: ${match.totalScore}`);
                                const iframe = $('<iframe></iframe>')
                                    .attr('src', `https://www.youtube.com/embed/${bestVideo.video_id}?start=${bestMatch.start_time}`)
                                    .attr('frameborder', '0')
                                    .attr('allowfullscreen', true);
                                const listItem = $('<li></li>').addClass('video-item').append(videoTitle, iframe);
                                videoList.append(listItem);
                                matchesFound++;
                                if (matchesFound === 10) {
                                    break;
                                }
                            }
                        }
                    }).fail(function() {
                        console.error('Failed to fetch video data');
                    });
                }).fail(function() {
                    console.error('Failed to fetch match data');
                    videoList.append('<div>Failed to load top matches. Please try again later.</div>');
                });
            }

            $('.selectregion').on('change', fetchAndRenderTopMatches);
            $('.selectauto').on('change', fetchAndRenderTopMatches);

            fetchAndRenderTopMatches();
        });
    </script>
</body>
</html>
